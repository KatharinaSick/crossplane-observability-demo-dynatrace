{{- if .Values.crossplaneTerraformProvider.install }}
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-terraform
spec:
  package: xpkg.upbound.io/upbound/provider-terraform:v0.14.1
---
{{- end }}
apiVersion: tf.upbound.io/v1beta1
kind: ProviderConfig
metadata:
  name: crossplane-observability-demo-dynatrace-{{ .Release.Name }}
spec:
  credentials:
    - filename: terraform.tfvars.json
      secretRef:
        key: credentials
        name: dynatrace-creds
        namespace: crossplane-system
      source: Secret
  configuration: |
    provider "dynatrace" {
      dt_env_url    = var.dt_env_url
      dt_api_token  = var.dt_api_token
    }

    variable "dt_env_url" {
      type = string
    }

    variable "dt_api_token" {
      type = string
    }

    variable "slack_webhook" {
      type = string
    }

    terraform {
      required_providers {
        dynatrace = {
          version = "1.52.0"
          source = "dynatrace-oss/dynatrace"
        }
      }

      // Modules _must_ use remote state. The provider does not persist state.
      backend "kubernetes" {
        secret_suffix     = "providerconfig-crossplane-observability-demo-dynatrace-{{ .Release.Name }}"
        namespace         = "upbound-system"
        in_cluster_config = true
      }
    }